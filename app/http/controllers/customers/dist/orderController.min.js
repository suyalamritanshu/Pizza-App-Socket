"use strict";var Order=require("../../../models/order"),moment=require("moment"),stripe=require("stripe")(process.env.STRIPE_PRIVATE_KEY);function orderController(){return{store:function(t,n){var e=t.body,r=e.phone,s=e.address,o=e.stripeToken,a=e.paymentType;if(!r||!s)return n.status(422).json({message:"Please fill all the fields."});new Order({customerId:t.user._id,items:t.session.cart.items,phone:r,address:s}).save().then(function(e){Order.populate(e,{path:"customerId"},function(e,r){if("card"!==a)return delete t.session.cart,n.json({message:"Order placed, Pay at delivery time"});stripe.charges.create({amount:100*t.session.cart.totalPrice,source:o,currency:"inr",description:"Pizza order: ".concat(r._id)}).then(function(){r.paymentStatus=!0,r.paymentType=a,r.save().then(function(e){return t.app.get("eventEmitter").emit("orderPlaced",e),delete t.session.cart,n.json({message:"Yay ðŸ˜€ðŸ˜€ Payment successful, Order placed Successfully"})}).catch(function(e){console.log(e)})}).catch(function(e){return delete t.session.cart,n.json({message:"Order placed but Payment failed, Dont worry you can also pay at delivery time"})})})}).catch(function(e){return n.status(500).json({message:"Something went wrong."})})},index:function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Order.find({customerId:r.user._id},null,{sort:{createdAt:-1}}));case 2:n=e.sent,t.header("Cache-Control","no-store"),t.render("customers/orders",{orders:n,moment:moment});case 5:case"end":return e.stop()}})},show:function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Order.findById(r.params.id));case 2:if(n=e.sent,r.user._id.toString()===n.customerId.toString())return e.abrupt("return",t.render("customers/singleOrder",{order:n}));e.next=7;break;case 7:return e.abrupt("return",t.redirect("/"));case 8:case"end":return e.stop()}})}}}module.exports=orderController;
//# sourceMappingURL=orderController.min.js.map
